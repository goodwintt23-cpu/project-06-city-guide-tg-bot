  // ЕДИНАЯ ERD (DBML) - САЙТ + TG-БОТ
// Группировка и метки для разработки: [CORE] / [TG] / [SITE]
// Принципы:
// - [CORE] единое ядро, общий источник истины для обеих веток
// - [TG] таблицы используются только логикой TG-бота (сайт не трогает)
// - [SITE] таблицы используются только сайтом (бот не трогает)
// - Telegram напрямую не пишет в БД: пишет только наша бизнес-логика (backend)
// - Избранное: только TG (без синхронизации с сайтом в MVP)
// - Широта/долгота не храним, достаточно адреса (генерация ссылки на карты на уровне приложения)

// ============================================================================
// [CORE] AUTH/ПОЛЬЗОВАТЕЛИ/РОЛИ (общий контур) 
// ============================================================================

Table Роль {
  роль_id int [pk, increment]
  код_роли varchar [null]        // было в TG
  наименование varchar
  область varchar [note: "admin|tg|both", default: "both"]

  indexes {
    (код_роли) [unique]
  }
}

Table Пользователь {
  пользователь_id int [pk, increment]

  // идентификация
  telegram_id bigint [unique, null]     // TG
  логин varchar [unique, null]          // админка
  пароль_hash varchar [null]            // админка

  роль_id int
  активен boolean [default: true]

  // TG-подписка
  статус_подписки_на_канал varchar [null]
  дата_проверки_подписки datetime [null]

  создано_в datetime [null]
  обновлено_в datetime [null]

  indexes {
    (роль_id)
    (telegram_id)
    (логин)
  }
}

Ref: Пользователь.роль_id > Роль.роль_id

// ============================================================================
// [CORE] СПРАВОЧНИКИ (общие)
// ============================================================================

Table Район {
  район_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Тип_места {
  тип_места_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Категория_события {
  категория_события_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

// ============================================================================
// [CORE] ЯДРО: МЕСТА И СОБЫТИЯ (общие для сайта и TG)
// ============================================================================

Table Место {
  место_id int [pk, increment]

  // связка с контентом сайта (если место публикуется на сайте)
  элемент_id int [unique, null] // FK -> [SITE] Элемент_наполнения.элемент_id

  название varchar
  адрес text [null]          // широта/долгота не используем
  телефон text [null]
  описание text [null]
  время_работы text [null]
  средний_чек numeric [null]

  район_id int [null]
  тип_места_id int [null]

  indexes {
    (район_id)
    (тип_места_id)
    (название)
  }
}

Ref: Место.район_id > Район.район_id
Ref: Место.тип_места_id > Тип_места.тип_места_id

Table Источник_событий {
  источник_событий_id int [pk, increment]
  наименование varchar
  base_url text [null] // может хранить ссылку на Яндекс-афишу (как внешний переход)

  indexes { (наименование) [unique] }
}

Table Событие {
  событие_id int [pk, increment]

  // связка с контентом сайта (если событие публикуется на сайте)
  элемент_id int [unique, null] // FK -> [SITE] Элемент_наполнения.элемент_id

  название varchar
  описание text [null]

  // временные атрибуты (суперсет сайта + TG)
  дата_начала date [null]
  дата_окончания date [null]
  время_начала time [null]
  время_окончания time [null]
  дата_и_время_проведения datetime [null] // TG-формат (если храните одним datetime)

  стоимость numeric [null]
  адрес text [null] // если нет место_id или адрес отличается от места

  // ссылки для UX сайта
  ссылка_официальный_источник text [null]
  ссылка_покупка_билета_или_регистрация text [null]

  // связи
  место_id int [null]
  категория_события_id int [null]
  источник_событий_id int [null]
  внешний_идентификатор text [null] // если когда-то будет импорт/агрегатор
  тип_источника varchar [note: "manual|external", default: "manual"] // тип_источника: manual - событие добавлено/отредактировано вручную (редакция/админка); external - получено из внешнего источника (агрегатор)

  indexes {
    (место_id)
    (категория_события_id)
    (дата_начала)
    (дата_и_время_проведения)
    (название)
  }
}

Ref: Событие.место_id > Место.место_id
Ref: Событие.категория_события_id > Категория_события.категория_события_id
Ref: Событие.источник_событий_id > Источник_событий.источник_событий_id

// ============================================================================
// [CORE] ПОДБОРКИ (общие, суперсет сайта)
// ============================================================================

Table Статус_публикации {
  статус_публикации_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Подборка {
  подборка_id int [pk, increment]
  название varchar
  описание text [null]

  // сайт-обвязка (может быть null для подборок, которые заводит бот или импорт)
  статус_публикации_id int [null]
  создано_пользователь_id int [null]
  создано_в datetime [null]
  обновлено_в datetime [null]

  indexes {
    (статус_публикации_id)
    (создано_пользователь_id)
    (название)
  }
}

Ref: Подборка.статус_публикации_id > Статус_публикации.статус_публикации_id
Ref: Подборка.создано_пользователь_id > Пользователь.пользователь_id

Table Элемент_подборки {
  подборка_id int
  место_id int
  порядок int [null]

  indexes {
    (подборка_id, место_id) [pk]
    (место_id)
  }
}

Ref: Элемент_подборки.подборка_id > Подборка.подборка_id
Ref: Элемент_подборки.место_id > Место.место_id

// ============================================================================
// [TG] TG-БОТ: ИЗБРАННОЕ (только TG, без синхронизации с сайтом)
// ============================================================================

Table Избранное_места {
  пользователь_id int
  место_id int
  дата_добавления datetime

  indexes {
    (пользователь_id, место_id) [pk]
    (место_id)
  }
}

Ref: Избранное_места.пользователь_id > Пользователь.пользователь_id
Ref: Избранное_места.место_id > Место.место_id

Table Избранное_события {
  пользователь_id int
  событие_id int
  дата_добавления datetime

  indexes {
    (пользователь_id, событие_id) [pk]
    (событие_id)
  }
}

Ref: Избранное_события.пользователь_id > Пользователь.пользователь_id
Ref: Избранное_события.событие_id > Событие.событие_id

// ============================================================================
// [TG] TG-БОТ: АКЦИИ/ПРОМОКОДЫ (единые, без учета выдачи)
// ============================================================================

Table Акция {
  акция_id int [pk, increment]
  место_id int
  описание_акции text [null]
  срок_действия_с date [null]
  срок_действия_по date [null]
  промокод varchar [null]
  дата_добавления datetime [null]

  indexes {
    (место_id)
    (срок_действия_с)
    (срок_действия_по)
    (промокод)
  }
}

Ref: Акция.место_id > Место.место_id

// ============================================================================
// [TG] TG-БОТ: ПОДКАТЕГОРИИ (только TG)
// ============================================================================

Table Подкатегория_места {
  подкатегория_места_id int [pk, increment]
  тип_места_id int
  наименование varchar

  indexes {
    (тип_места_id)
    (наименование)
  }
}

Ref: Подкатегория_места.тип_места_id > Тип_места.тип_места_id

Table Место_Подкатегория {
  место_id int
  подкатегория_места_id int

  indexes { (место_id, подкатегория_места_id) [pk] }
}

Ref: Место_Подкатегория.место_id > Место.место_id
Ref: Место_Подкатегория.подкатегория_места_id > Подкатегория_места.подкатегория_места_id

// ============================================================================
// [CORE] ФОТО для карточек (обложка/первое фото места/события) - общий слой для [TG] и [SITE].
// "Фото_альбом/Фото_альбома" - контент фотогалереи [SITE] и не является источником фото для карточек.
// Маркировка: [CORE], чтобы не плодить дубликаты.
// ============================================================================

Table Фото_места {
  фото_места_id int [pk, increment]
  место_id int
  url_фото text

  indexes { (место_id) }
}

Ref: Фото_места.место_id > Место.место_id

Table Фото_события {
  фото_события_id int [pk, increment]
  событие_id int
  url_фото text

  indexes { (событие_id) }
}

Ref: Фото_события.событие_id > Событие.событие_id

// ============================================================================
// [SITE] САЙТ: СТРУКТУРА И CMS-КОНТЕНТ
// ============================================================================

Table Раздел_сайта {
  раздел_id int [pk, increment]
  родитель_раздел_id int [null]
  наименование varchar
  порядок int
  активен boolean

  indexes {
    (родитель_раздел_id)
    (порядок)
    (наименование)
  }
}

Ref: Раздел_сайта.родитель_раздел_id > Раздел_сайта.раздел_id

Table Статическая_страница {
  статическая_страница_id int [pk, increment]
  раздел_id int
  заголовок varchar
  полный_текст text
  создано_пользователь_id int
  создано_в datetime
  обновлено_в datetime
  статус_публикации_id int

  indexes {
    (раздел_id)
    (статус_публикации_id)
    (создано_пользователь_id)
  }
}

Ref: Статическая_страница.раздел_id > Раздел_сайта.раздел_id
Ref: Статическая_страница.создано_пользователь_id > Пользователь.пользователь_id
Ref: Статическая_страница.статус_публикации_id > Статус_публикации.статус_публикации_id

Table Тип_контента {
  тип_контента_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Элемент_наполнения {
  элемент_id int [pk, increment]
  тип_контента_id int

  заголовок varchar
  краткое_описание text [null]
  полный_текст text [null]
  дата_публикации datetime [null]

  статус_публикации_id int
  создано_пользователь_id int
  создано_в datetime
  обновлено_в datetime

  indexes {
    (тип_контента_id)
    (статус_публикации_id)
    (создано_пользователь_id)
    (дата_публикации)
  }
}

Ref: Элемент_наполнения.тип_контента_id > Тип_контента.тип_контента_id
Ref: Элемент_наполнения.статус_публикации_id > Статус_публикации.статус_публикации_id
Ref: Элемент_наполнения.создано_пользователь_id > Пользователь.пользователь_id

// связка ядра с CMS (site->core)
// элемент_id хранится в [CORE] Место/Событие и является ссылкой на [SITE] Элемент_наполнения
Ref: Место.элемент_id > Элемент_наполнения.элемент_id
Ref: Событие.элемент_id > Элемент_наполнения.элемент_id

// ============================================================================
// [SITE] САЙТ: МАРШРУТЫ И ТОЧКИ
// ============================================================================

Table Маршрут {
  элемент_id int [pk]
}
Ref: Маршрут.элемент_id > Элемент_наполнения.элемент_id

Table Маршрут_Точка {
  маршрут_точка_id int [pk, increment]
  маршрут_id int
  порядок int
  место_id int [null]
  описание_точки text [null]
}
Ref: Маршрут_Точка.маршрут_id > Маршрут.элемент_id
Ref: Маршрут_Точка.место_id > Место.место_id

// ============================================================================
// [SITE] САЙТ: ДОП.ТИПЫ КОНТЕНТА (1:1 к Элемент_наполнения)
// ============================================================================

Table Лицо_города {
  элемент_id int [pk]
  имя text [null]
}
Ref: Лицо_города.элемент_id > Элемент_наполнения.элемент_id

Table Гайд {
  элемент_id int [pk]
  цена numeric [null]
  ссылка_покупка_или_страница_оплаты text [null]
  ссылка_получение_или_скачивание text [null]
}
Ref: Гайд.элемент_id > Элемент_наполнения.элемент_id

// [SITE] [ЗАГЛУШКА] Покупка гайда: способ оплаты/провайдеры TBD
Table Покупка_гайда {
  покупка_гайда_id int [pk, increment]
  гайд_id int
  email text [null]
  телефон text [null]
  сумма numeric [null]
  валюта varchar [null]
  статус varchar [note: "created|paid|failed|refunded", null]
  платежный_провайдер varchar [null]
  внешний_payment_id text [null]
  access_token text [null]
  access_expires_at datetime [null]
  создано_в datetime
  оплачено_в datetime [null]
}
Ref: Покупка_гайда.гайд_id > Гайд.элемент_id

Table Розыгрыш_или_Конкурс {
  элемент_id int [pk]
  дата_начала date [null]
  дата_окончания date [null]
}
Ref: Розыгрыш_или_Конкурс.элемент_id > Элемент_наполнения.элемент_id

Table Материал_Красота_и_Здоровье {
  элемент_id int [pk]
}
Ref: Материал_Красота_и_Здоровье.элемент_id > Элемент_наполнения.элемент_id

Table Фото_альбом {
  элемент_id int [pk]
}
Ref: Фото_альбом.элемент_id > Элемент_наполнения.элемент_id

Table Фото_альбома {
  фото_id int [pk, increment]
  фото_альбом_id int
  url_фото text
  подпись text [null]
  порядок int [null]
}
Ref: Фото_альбома.фото_альбом_id > Фото_альбом.элемент_id

Table Видео_материал {
  элемент_id int [pk]
  url_видео text
  платформа text [null]
}
Ref: Видео_материал.элемент_id > Элемент_наполнения.элемент_id

// ============================================================================
// [SITE] САЙТ: ОТЗЫВЫ, ТЕГИ, КУХНИ
// ============================================================================

Table Отзыв {
  отзыв_id int [pk, increment]
  место_id int
  автор_имя text [null]
  рейтинг int [null]
  текст text [null]
  дата_публикации datetime [null]
  источник_ссылка text [null]

  indexes { (место_id) }
}
Ref: Отзыв.место_id > Место.место_id

Table Кухня {
  кухня_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Тег {
  тег_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Место_Кухня {
  место_id int
  кухня_id int

  indexes { (место_id, кухня_id) [pk] }
}
Ref: Место_Кухня.место_id > Место.место_id
Ref: Место_Кухня.кухня_id > Кухня.кухня_id

Table Место_Тег {
  место_id int
  тег_id int

  indexes { (место_id, тег_id) [pk] }
}
Ref: Место_Тег.место_id > Место.место_id
Ref: Место_Тег.тег_id > Тег.тег_id

// ============================================================================
// [SITE] САЙТ: ФОРМЫ/ЗАЯВКИ
// ============================================================================

Table Тип_заявки {
  тип_заявки_id int [pk, increment]
  наименование varchar

  indexes { (наименование) [unique] }
}

Table Заявка_через_форму {
  заявка_id int [pk, increment]
  тип_заявки_id int

  имя text [null]
  email text [null]
  телефон text [null]
  текст text [null]
  ссылка text [null]

  создано_в datetime
  статус_обработки text [null]

  indexes {
    (тип_заявки_id)
    (создано_в)
    (email)
    (телефон)
  }
}

Ref: Заявка_через_форму.тип_заявки_id > Тип_заявки.тип_заявки_id