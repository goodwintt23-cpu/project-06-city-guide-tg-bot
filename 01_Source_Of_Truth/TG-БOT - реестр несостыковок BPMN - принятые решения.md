
Дата: 2026-02-03  
Контекст: BPMN telegram-бот содержит спорные шаги/заглушки. В “источнике истины” приоритет у меток в ТЗ: [РЕШЕНО] и [УТОЧНЕНИЕ] на основании этапа валидации/выборки Q&A telegram-бот. 

## 0) Артефакты, на которые опирались при решениях

- ТЗ telegram-бот (метки [РЕШЕНО], [УТОЧНЕНИЕ], [ЗАГЛУШКА])
- API telegram-бот
- UML Sequence SEQ-01..SEQ-10
- DFD L1
- ERD + Data Dictionary

---

## 1) Несостыковки BPMN -> решение

### BPMN-ERR-01 (Критично) Подписка: запись в БД и “перевод” пользователя в бота

**Где в BPMN:**
- “Datastore: Пользователь добавлен в БД” после “Присоединиться к каналу”
- “Вернуться в бот” как будто канал осуществляет переход

**В чем проблема:**
- Telegram-канал не пишет в нашу БД и не выполняет “переход” в чат-бот. Возврат делает пользователь стандартной навигацией Telegram.
- Статус подписки проверяется нашей системой (бот/бэкенд) через Telegram API (membership check). При необходимости фиксируем результат проверки в нашей БД, но это действие бэкенда, не Telegram.

**Принятое решение:**
- Убрать из BPMN шаг “Datastore: Пользователь добавлен в БД” как следствие “Присоединиться к каналу”.
- Убрать формулировки, где Telegram-канал “возвращает” в бота.
- Зафиксировать корректный момент записи/обновления пользователя:
    - запись/обновление в нашей БД выполняет бэкенд при обработке действия пользователя в боте, после проверки membership через Telegram API.

**Что правим в BPMN:**
- В ветке подписки оставить только: “Пользователь подписался (вне контура системы)” -> “Пользователь вернулся в бот” -> “Бот повторно проверил membership” -> “Показал главное меню”.

---

### BPMN-ERR-02 (Средняя) Обратная связь: “ввести текст и отправить”, но канал обработки не определен и противоречит MVP

**Где в BPMN:**
- “Отправить сообщение” -> “Ввести текст” -> “Подтвердить отправку”
- При этом в BPMN прямо отмечено, что куда сохраняется/маршрутизируется - не раскрыто.

**В чем проблема:**
- В ТЗ зафиксировано решение для MVP: общение в личке TG аккаунта администратора и пользователя, без хранения истории в системе.
- Текущая BPMN-ветка создает ожидание, что бот принимает и обрабатывает текст (а это уже сущности, хранение/маршрутизация, права, модерация).

**Принятое решение:**
- В MVP “Обратная связь” = показать контакты/кнопку перехода в личные сообщения администратора (username/link), без приема текста ботом и без хранения в БД.

**Что правим в BPMN:**
- Заменить шаги “ввести текст/подтвердить отправку” на:
    - “Показать контакты/кнопку ‘Написать админу’ (открытие личного чата)” + “Вернуться в меню”.

---

### BPMN-ERR-03 (Средняя) Яндекс.Карты: ответственность шагов и “модальное подтверждение”

**Где в BPMN:** 
- “Найти на Яндекс-картах -> Получить ссылку -> Перейти по ссылке”
- Есть пометка [УТОЧНЕНИЕ] про смешение ответственности.

**В чем проблема:**
- В ТЗ местами описано “модальное уведомление для подтверждения перехода”, кнопки “Открыть/Отмена”.
- В фактической реализации TG UX для MVP проще и консистентнее: inline-кнопка с url. Подтверждение перехода (если показывается) находится на стороне Telegram/ОС, а не как отдельный сценарий бота.

**Принятое решение:**
- В MVP используем url-кнопку “Найти на Яндекс-Картах” (inline keyboard, поле `url`).
- Бэкенд формирует URL по адресу (без координат), Telegram только открывает ссылку. Собственная “модалка” от бота не реализуется.

**Что правим в BPMN:**
- Упростить блок карт до одного действия:
    - “Пользователь нажал кнопку url -> открыл Яндекс.Карты”.
- Убрать шаги вида “получить ссылку” как отдельную активность пользователя. Это внутренняя операция бэкенда перед отправкой сообщения.

---

### BPMN-ERR-04 (Низкая) Подборки: неполный список (обрезано на PNG)

**Где в BPMN:**
- список “8 вариантов”, но часть пунктов обрезана и помечена [УТОЧНЕНИЕ].

**В чем проблема:**
- BPMN пытается перечислить конкретные значения, но источника полного списка в этом документе нет.

**Принятое решение:**
- В BPMN оставить обобщение “Выбрать подборку из списка”, без перечисления всех значений.
- Полный список - данные контента, источник CMS (а не уровень BPMN).

**Что правим в BPMN:**
- Удалить неполный перечень, заменить на “Список подборок (контент из CMS)”.

---

### BPMN-ERR-05 (Низкая) “ЧАТ БОТ/API” как один исполнитель в шагах получения результата

**Где в BPMN:**
- “Получить результат (ЧАТ БОТ/API)”

**В чем проблема:**
- В BPMN смешаны роли бота и бэкенда. Для разработки лучше фиксировать: бот инициирует запрос, бэкенд читает БД, бот отображает.

**Принятое решение:**
- Развести ответственность:
    - Бот (UI) -> запрос в бэкенд -> бэкенд читает БД/формирует ответ -> бот отображает список/карточку.

**Что правим в BPMN:**
- Либо уточнить подписи задач, либо добавить примечание “операции чтения/выборки выполняет бэкенд”.

---

## 2) Сводка принятых решений (для раздела “Решения” в ТЗ)

1. Подписка:
- Telegram не пишет в нашу БД и не переводит пользователя в бота.
- Статус подписки проверяет наша система через Telegram API. Если фиксация нужна, ее делает бэкенд после проверки.

2. Обратная связь:
- В MVP нет хранения и обработки текстовых обращений в системе.
- Канал общения - личка TG аккаунтов админа и пользователя (переход по ссылке/username).

3. Яндекс.Карты:
- В MVP переход по url-кнопке.
- URL формируется по адресу, без координат. Отдельные “модальные подтверждения” от бота не реализуем.

4. Подборки:
- BPMN не перечисляет значения, это контент CMS. В процессе фиксируем только факт выбора подборки.